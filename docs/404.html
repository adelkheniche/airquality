<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality - Ceramics Workshop</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    
    <!-- Day.js with timezone -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/timezone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/customParseFormat.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Feather Icons -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-50 font-sans">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <i data-feather="wind" class="h-8 w-8 text-blue-600 mr-3"></i>
                    <h1 class="text-2xl font-bold text-gray-900">Air Quality - Ceramics Workshop</h1>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading State -->
        <div id="loading" class="flex justify-center items-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <span class="ml-3 text-gray-600">Loading data...</span>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden bg-red-50 border border-red-200 rounded-md p-4 mb-6">
            <div class="flex">
                <i data-feather="alert-circle" class="h-5 w-5 text-red-400"></i>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Loading Error</h3>
                    <div class="mt-2 text-sm text-red-700" id="error-message"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="hidden">
            <!-- Controls -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex flex-wrap items-center gap-4 mb-4">
                    <div class="flex items-center space-x-2">
                        <label for="date-from" class="text-sm font-medium text-gray-700">From:</label>
                        <input type="date" id="date-from" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="date-to" class="text-sm font-medium text-gray-700">To:</label>
                        <input type="date" id="date-to" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                    </div>
                    <button id="apply-filters" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700">
                        Apply
                    </button>
                    <button id="add-activity-btn" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm hover:bg-green-700">
                        <i data-feather="plus" class="h-4 w-4 inline mr-1"></i>
                        Add Activity
                    </button>
                </div>
                
                <!-- Tag Filters -->
                <div class="flex flex-wrap gap-2" id="tag-filters">
                    <!-- Tags will be populated by JavaScript -->
                </div>
            </div>

            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i data-feather="activity" class="h-8 w-8 text-blue-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">PM2.5 Median</dt>
                                <dd class="text-lg font-medium text-gray-900" id="kpi-median">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i data-feather="alert-triangle" class="h-8 w-8 text-amber-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">% Time > 15 µg/m³</dt>
                                <dd class="text-lg font-medium text-gray-900" id="kpi-over15">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i data-feather="trending-up" class="h-8 w-8 text-red-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Peaks / Hour</dt>
                                <dd class="text-lg font-medium text-gray-900" id="kpi-peaks">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Pills -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Current Status</h3>
                <div class="flex space-x-4" id="status-pills">
                    <!-- Status pills will be populated by JavaScript -->
                </div>
            </div>

            <!-- Heatmap -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Carte de Chaleur Jour×Heure - PM2.5 Médiane</h3>
                
                <!-- ARIA Live Region -->
                <div id="heatmap-status" class="sr-only" aria-live="polite" aria-atomic="true"></div>
                
                <!-- Threshold Legend -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <span class="threshold-chip threshold-ok">
                        <span class="threshold-indicator"></span>
                        &lt; 15 µg/m³ OK
                    </span>
                    <span class="threshold-chip threshold-monitor">
                        <span class="threshold-indicator"></span>
                        15–25 µg/m³ Surveillance
                    </span>
                    <span class="threshold-chip threshold-risk">
                        <span class="threshold-indicator"></span>
                        &gt; 25 µg/m³ À Risque
                    </span>
                </div>
                
                <!-- Busy Hours Summary -->
                <div id="busy-hours-summary" class="text-sm text-gray-700 mb-4 font-medium"></div>
                
                <!-- Heatmap Figure -->
                <figure class="heatmap-container">
                    <div id="heatmap" class="heatmap-chart" style="height: 480px;" tabindex="0" role="img" aria-describedby="heatmap-caption"></div>
                    <figcaption id="heatmap-caption" class="text-sm text-gray-600 mt-2">
                        Carte de chaleur montrant la concentration médiane de PM2.5 par jour de la semaine et heure de la journée. 
                        Les valeurs plus élevées (couleurs plus chaudes) indiquent une pollution de l'air plus importante.
                    </figcaption>
                </figure>
                
                <!-- Export Button -->
                <div class="flex justify-end mt-4">
                    <button id="export-heatmap" class="btn-export">
                        <i data-feather="download" class="h-4 w-4 mr-2"></i>
                        Exporter en PNG
                    </button>
                </div>
            </div>

            <!-- Activities Risk Table -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Activities → Risk</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="activities-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hashtag</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hours Observed</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Median (µg/m³)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P95 (µg/m³)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% > 15</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peaks/h</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AUC/h</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recommendations</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="activities-tbody">
                            <!-- Rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Peaks List -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Peaks List</h3>
                <div id="peaks-list">
                    <!-- Peaks will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <!-- Add Activity Modal -->
    <div id="activity-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Add Activity</h3>
                    <form id="activity-form">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="start-datetime" class="block text-sm font-medium text-gray-700">Start</label>
                                <input type="datetime-local" id="start-datetime" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label for="end-datetime" class="block text-sm font-medium text-gray-700">End</label>
                                <input type="datetime-local" id="end-datetime" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hashtags</label>
                            <div id="activity-tags" class="space-y-2">
                                <!-- Tags will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="activity-note" class="block text-sm font-medium text-gray-700">Note (optional)</label>
                            <textarea id="activity-note" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="save-activity" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        Save
                    </button>
                    <button type="button" id="cancel-activity" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50">
        <!-- Toasts will be added here -->
    </div>

    <script src="config.js"></script>
    <script src="main.js"></script>
</body>
</html>
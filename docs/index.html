<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qualité de l’air – Atelier Céramique</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Stylesheet with design tokens -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="h-full bg-violet-50" x-data="dashboard()">
  <!-- Header with title and date range filters -->
  <header class="max-w-7xl mx-auto p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-gray-800">Qualité de l’air – Atelier Céramique</h1>
    <div class="space-x-2 text-sm">
      <input type="date" x-model="startDate" @change="updateData()" class="border border-gray-300 rounded px-2 py-1" />
      <span class="text-gray-600">–</span>
      <input type="date" x-model="endDate" @change="updateData()" class="border border-gray-300 rounded px-2 py-1" />
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 pb-8 space-y-8">
    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Card: Total Peaks -->
      <div class="bg-white rounded-lg shadow p-4 flex flex-col">
        <div class="text-3xl font-bold text-gray-800" x-text="peakCount"></div>
        <div class="text-sm text-gray-600">Nombre de pics</div>
      </div>
      <!-- Card: Peaks per Hour with status icon -->
      <div class="bg-white rounded-lg shadow p-4 flex flex-col">
        <div class="flex items-center space-x-2">
          <span class="text-3xl font-bold text-gray-800" x-text="peaksPerHour.toFixed(1)"></span>
          <!-- Status icons for peaks/hour (green=good, yellow=warn, red=alert) -->
          <svg x-show="peaksPerHourStatus === 'green'" class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <svg x-show="peaksPerHourStatus === 'yellow'" class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <svg x-show="peaksPerHourStatus === 'red'" class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="text-sm text-gray-600">Pics par heure</div>
      </div>
      <!-- Card: % Time > 15µg with status icon -->
      <div class="bg-white rounded-lg shadow p-4 flex flex-col">
        <div class="flex items-center space-x-2">
          <span class="text-3xl font-bold text-gray-800" x-text="percentOver15.toFixed(1) + '%'"></span>
          <!-- Status icons for %>15µg (green=good, yellow=warn, red=alert) -->
          <svg x-show="percentStatus === 'green'" class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <svg x-show="percentStatus === 'yellow'" class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <svg x-show="percentStatus === 'red'" class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="text-sm text-gray-600">% du temps &gt; 15 µg/m³</div>
      </div>
    </div>

    <!-- Charts Section: PM1, PM2.5, PM10 time series -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
      <div class="bg-white rounded-lg shadow p-2">
        <div id="chart-pm1" class="w-full h-64"></div>
      </div>
      <div class="bg-white rounded-lg shadow p-2">
        <div id="chart-pm25" class="w-full h-64"></div>
      </div>
      <div class="bg-white rounded-lg shadow p-2">
        <div id="chart-pm10" class="w-full h-64"></div>
      </div>
    </div>

    <!-- Activities summary table and Peaks list -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Activities Table -->
      <div class="bg-white rounded-lg shadow p-4 overflow-x-auto">
        <h3 class="text-base font-semibold text-gray-800 mb-2">Activités</h3>
        <table class="min-w-full table-zebra text-sm text-gray-800">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="pb-1 text-left">Activité</th>
              <th class="pb-1 text-right">Durée (h)</th>
              <th class="pb-1 text-right">Pics</th>
              <th class="pb-1 text-right">Pics/h</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="row in summaryList" :key="row.tag">
              <tr>
                <td class="py-1 pr-3" x-text="row.tag"></td>
                <td class="py-1 px-3 text-right tabular-nums" x-text="row.duration.toFixed(1)"></td>
                <td class="py-1 px-3 text-right tabular-nums" x-text="row.peaks"></td>
                <td class="py-1 pl-3 text-right tabular-nums" x-text="(row.peaks / row.duration).toFixed(1)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      <!-- Peaks List -->
      <div class="bg-white rounded-lg shadow p-4">
        <h3 class="text-base font-semibold text-gray-800 mb-2">Pics détectés</h3>
        <ul class="text-sm text-gray-800 list-disc list-inside space-y-1">
          <template x-for="p in peaksList" :key="p.ts">
            <li>
              <span x-text="dayjs.utc(p.ts).tz('Europe/Paris').format('DD/MM/YYYY HH:mm')"></span>
              – 
              <span x-text="p.value.toFixed(1) + ' µg/m³'"></span>
            </li>
          </template>
        </ul>
      </div>
    </div>
  </main>

  <!-- Scripts: Supabase, Day.js, Plotly, Alpine, Config, Main -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/timezone.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.18.2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.0/dist/cdn.min.js" defer></script>
  <script src="config.js"></script>
  <script src="main.js"></script>
</body>
</html>
